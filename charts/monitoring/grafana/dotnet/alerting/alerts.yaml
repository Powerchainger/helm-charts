apiVersion: 1
groups:
  - name: Services Alerts
    folder: "{{ .application }}"
    interval: 1m
    rules:
      - uid: service_cpu_usage_high
        title: High Process CPU Usage
        condition: B
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 600, to: 0 }
            model:
              expr: |
                sum by (pod) (rate(process_cpu_time_seconds_total{job="{{ .application }}", namespace="{{ .namespace }}"}[5m])) * 100
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - type: query
                  reducer: { type: last, params: [] }
                  evaluator: { type: gt, params: [80] }
        for: 5m
        noDataState: NoData
        execErrState: Alerting
        labels:
          severity: warning
        annotations:
          __dashboardUid__: '{{ .uid }}-alerts-dashboard'
          __panelId__: '2'
          summary: "CPU is over 80% for service {{ .application }} in namespace {{ .namespace }}"
          description: "Service: {{ .application }} | Namespace: {{ .namespace }}"

      - uid: service_dotnet_exceptions_high
        title: High .NET Runtime Exception Rate
        condition: B
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 600, to: 0 }
            model:
              expr: |
                sum by (pod) (increase(process_runtime_dotnet_exceptions_count_total{job="{{ .application }}", namespace="{{ .namespace }}"}[2m]))
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - type: query
                  reducer: { type: last, params: [] }
                  evaluator: { type: gt, params: [5] }
        for: 2m
        noDataState: NoData
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          __dashboardUid__: '{{ .uid }}-alerts-dashboard'
          __panelId__: '4'
          summary: "More than 5 exceptions (2m) for service {{ .application }} in namespace {{ .namespace }}"
          description: "Service: {{ .application }} | Namespace: {{ .namespace }}"

      - uid: service_http_5xx_errors_high
        title: High percentage of 5xx errors
        condition: B
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange: { from: 600, to: 0 }
            model:
              expr: |
                sum by (pod) (increase(http_server_request_duration_seconds_count{http_response_status_code=~"5..", job="{{ .application }}", namespace="{{ .namespace }}", http_route!~"/metrics|/ready|/alive"}[1m]))
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - type: query
                  reducer: { type: last, params: [] }
                  evaluator: { type: gt, params: [10] }
        for: 1m
        noDataState: NoData
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          __dashboardUid__: '{{ .uid }}-alerts-dashboard'
          __panelId__: '6'
          summary: "More than 10 5xx errors (1m) for service {{ .application }} in namespace {{ .namespace }}"
          description: "Service: {{ .application }} | Namespace: {{ .namespace }}"